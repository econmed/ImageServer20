<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <title>Breast Imaging</title>
        <link href="css/default.css" rel="stylesheet" type="text/css" />
        <link href="js/calendar/calendar-system.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="js/calendar/calendar.js"></script>
        <script type="text/javascript" src="js/calendar/lang/calendar-en.js"></script>
        <script type="text/javascript" src="js/jsx.js"></script>
	    <script type="text/javascript" src="js/jsml.js"></script>
	    <script type="text/javascript" src="js/ui.js"></script>
	    <script type="text/javascript" src="js/ris.js"></script>
	    <script type="text/javascript" >
		    var data = {};
		    var errorProvider = new ErrorProvider();
	    
		    function onBodyLoad()
		    {
		        if(Ris)
		        {
			        data = JSML.parse(Ris.getData("ExamDetails")) || {};
			    }
			    
			    var myForm = $("myForm");
			    myForm.studyType.value = data.studyType || "";
			    myForm.filmsUsedCount.value = data.filmsUsedCount || "";
			    
			    data.repeats = data.repeats || [];
			    
		        var repeatsTable = Table.createTable($("repeatsTable"), { editInPlace: true, flow: true },
		             [
		                {   label: "Repeats",
		                    cellType: "text",
		                    getValue: function(item) { return item.repeatCount; },
		                    setValue: function(item, value) { item.repeatCount = value; },
		                    getError: function(item) { return parseInt(item.repeatCount) > 0 ? null : "Repeat count required"; }
		                },
		                {   label: "Reason",
		                    cellType: "choice",
		                    choices: ["artifacts", "equipment failure", "motion", "positioning", "processor", "technique"],
		                    getValue: function(item) { return item.reason; },
		                    setValue: function(item, value) { item.reason = value; },
		                    getError: function(item) { return item.reason ? null : "Reason required"; }
		                }
		             ]);
		             
		        repeatsTable.errorProvider = errorProvider;   // share errorProvider with the rest of the form
		        repeatsTable.bindItems(data.repeats);
		        
		        updateValidation();
		    }
		    
		    //////////////////////////////////////////////////////////////////////////
		    // RIS integration API
		    function showValidation(show)
			{
			    errorProvider.setVisible(show);
			}
			
			function hasValidationErrors()
			{
			    return errorProvider.hasErrors();
			}
		    
		    function saveData()
		    {
			    var myForm = $("myForm");
		        data.studyType = myForm.studyType.value;
		        data.filmsUsedCount =  myForm.filmsUsedCount.value;
				Ris.setData("ExamDetails", JSML.create(data, "data"));
		    }
		    //////////////////////////////////////////////////////////////////////////
			
			function onAddRepeat()
			{
			    data.repeats.add( {} );   // add an empty item
			}
			
			function onDeleteRepeat()
			{
			    var checkedItems = $("repeatsTable").getCheckedItems();
			    if(checkedItems.length > 0)
			    {
			        if(confirm("Deleted selected repeats?"))
			        {
			            checkedItems.each(function(item) { data.repeats.remove(item); });
			            $("repeatsCheckAllNone").checked = false;
			        }
			    }
			    else
			    {
			        alert("Nothing selected");
			    }
			}
			function onRepeatsCheckAllNone()
			{
			    data.repeats.each(function(item) { $("repeatsTable").setItemCheckState(item, $("repeatsCheckAllNone").checked); });
			}
			function updateValidation()
			{
			    var myForm = $("myForm");
			    errorProvider.setError(myForm.studyType, myForm.studyType.value ? "" : "Study type required");
			    errorProvider.setError(myForm.filmsUsedCount, (parseInt(myForm.filmsUsedCount.value) > 0) ? "" : "Number of films used must be a positive integer");
			}
		</script>
	</head>
	<body onload="javascript: onBodyLoad()">
	
		<form id="myForm">
		<p class="sectionheading">Study</p>
		<p>
		    Study Type
		    <select id="studyType" onchange="updateValidation()">
		        <option value="Analog">Analog</option>
		        <option value="Digital">Digital</option>
		    </select>
		    
		    Number of Films Used<input type="text" id="filmsUsedCount" onkeyup="updateValidation()"/>
		</p>
		<p></p>
		<p class="sectionheading">Repeats</p>
		<p>
		    <input type="button" value="Add" onclick="javascript: onAddRepeat()" />
		    <input type="button" value="Delete" onclick="javascript: onDeleteRepeat()" />
		</p>
			<table id="repeatsTable" border="1">
			  <tr>
			    <td><input id="repeatsCheckAllNone" type="checkbox" onclick="javascript: onRepeatsCheckAllNone()" /></td>
				<td class="tableheading">Repeats</td>
			  </tr>
			</table>
		</form>
	</body>
</html>