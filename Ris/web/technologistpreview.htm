<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <title>Technologist Preview</title>
        <link href="css/default.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="js/jsx.js"></script>
	    <script type="text/javascript" src="js/jsml.js"></script>
	    <script type="text/javascript" src="js/ui.js"></script>
	    <script type="text/javascript" src="js/ris.js"></script>
	    <script type="text/javascript" src="js/preview.js"></script>
	    <script type="text/javascript" >
		    var data = {};
		    var errorProvider = new ErrorProvider();

		    function onBodyLoad()
		    {		        
		        if(!Ris)
		            return;
		        
	            try
	            {
					var worklistItem = Ris.getWorklistItem();
					if (worklistItem == null)
					{
                        Field.setValue($("myForm"), "");
                        return;
					}

                    var request = {
                        ProcedureStepRef: worklistItem.ProcedureStepRef,
                        GetModalityProcedureStepRequest: { GetDiagnosticServiceBreakdown: true },
                        GetPatientProfileRequest:        {},
                        ListPatientOrdersRequest:        { QueryDetailLevel: "RequestedProcedure" },
                        GetPatientAlertsRequest:         {}
                    };
                    
                    var service = Ris.getService("ClearCanvas.Ris.Application.Common.PreviewService.IPreviewService, ClearCanvas.Ris.Application.Common");
                    data = service.getData(request);

                    if (data == null || data.length == 0)
                    {
                        Field.setValue($("myForm"), "");
                        return;
                    }

		            // update patient demography
		            var patientName = "This patient";
		            if (data.GetPatientProfileResponse && data.GetPatientProfileResponse.PatientProfileDetail)
		            {
		                var patientProfile = data.GetPatientProfileResponse.PatientProfileDetail;
		                patientName = Ris.formatPersonName(patientProfile.Name);
		                Field.setValue($("name"), patientName);
			            Field.setValue($("mrn"), Ris.formatMrn(patientProfile.Mrn));
			            Field.setValue($("sex"), patientProfile.Sex.Value);					
			            Field.setValue($("dateOfBirth"), Ris.formatDate(patientProfile.DateOfBirth));
			            Field.setValue($("healthcard"), Ris.formatHealthcard(patientProfile.Healthcard));
		            }

                    // update patient alerts
		            if (data.GetPatientAlertsResponse && data.GetPatientAlertsResponse.AlertNotifications && data.GetPatientAlertsResponse.AlertNotifications.length > 0)
		            {
    	                var alertNotifications = data.GetPatientAlertsResponse.AlertNotifications;
                        var alertHtml = "";
	                    alertNotifications.each(function(item) { alertHtml += getAlertHtml(item, patientName); });
                        $("alerts").innerHTML = alertHtml;
		            }
		            
		            if (data.GetModalityProcedureStepResponse)
		            {
		                var mpsData = data.GetModalityProcedureStepResponse.PatientOrderData;

                        if (mpsData)
                        {
    		                // update Imaging Consultation Overview
		                    Field.setValue($("AccessionNumber"), mpsData.AccessionNumber);
		                    Field.setValue($("OrderPriority"), mpsData.OrderPriority);
		                    Field.setValue($("OrderingPhysician"), Ris.formatPersonName(mpsData.OrderingPractitionerName));
		                    Field.setValue($("OrderingFacility"), mpsData.OrderingFacilityName);

    		                // update Selected MPS Detail
		                    Field.setValue($("MPSName"), mpsData.ModalityProcedureStepTypeName);
		                    Field.setValue($("Modality"), mpsData.Modality);
		                    Field.setValue($("ProcedureStepStatus"), mpsData.ProcedureStepStatus);
		                    Field.setValue($("DiscontinueReason"), mpsData.DiscontinueReason);
		                    if (mpsData.DiscontinueReason == null || mpsData.DiscontinueReason.length == 0)
    		                    Field.show($("DiscontinueReasonRow"), false);

		                    Field.setValue($("AssignedStaff"), Ris.formatPersonName(mpsData.ScheduledPerformerStaffName));
		                    Field.setValue($("PerformingStaff"), Ris.formatPersonName(mpsData.PerformerStaffName));
		                    Field.setValue($("ScheduledStartTime"), Ris.formatDateTime(mpsData.ScheduledStartTime));
		                    Field.setValue($("ScheduledEndTime"), Ris.formatDateTime(mpsData.ScheduledEndTime));
		                    Field.setValue($("StartTime"), Ris.formatDateTime(mpsData.StartTime));
		                    Field.setValue($("EndTime"), Ris.formatDateTime(mpsData.EndTime));
		                }

                        var dsBreakdown = data.GetModalityProcedureStepResponse.DiagnosticServiceBreakdown;
    		            if (dsBreakdown)
    		            {
                            var dsTable = createDiagnosticServiceBreakdownTable($("dsBreakdownTable"));
	                        dsTable.errorProvider = errorProvider;   // share errorProvider with the rest of the form
                            dsTable.bindItems(dsBreakdown);
    		            }
		            }
		            
                    // update active and past RIC tables
		            if (data.ListPatientOrdersResponse && data.ListPatientOrdersResponse.PatientOrderData && data.ListPatientOrdersResponse.PatientOrderData.length > 0)
		            {
    		            var patientOrderData = data.ListPatientOrdersResponse.PatientOrderData;

                        // group patientOrderData by AccessionNumber
                        var orders = groupDataToOrders(patientOrderData);

		                var today = Date.today();
		                var pastOrders = orders.select(
		                    function(item) 
		                    { 
		                        return item.EarliestScheduledMPSDateTime && Date.compare(item.EarliestScheduledMPSDateTime, today) < 0;
		                    }).sort(orderDataComparison);

		                var activeOrders = orders.select(
		                    function(item) 
		                    { 
		                        return item.EarliestScheduledMPSDateTime && Date.compare(item.EarliestScheduledMPSDateTime, today) >= 0;
		                    }).sort(orderDataComparison);

//			            var notScheduledOrders = orders.select(
//			                function(item) 
//			                { 
//			                    return item.EarliestScheduledMPSDateTime == null;
//			                });
//			            activeOrders = activeOrders.concat(notScheduledOrders);

                        if (activeOrders.length == 0)
                        {
                            Field.show($("activeOrdersTable"), false);
                        }
                        else
                        {
                            var activeOrdersTable = createOrdersTable($("activeOrdersTable"));
	                        activeOrdersTable.errorProvider = errorProvider;   // share errorProvider with the rest of the form
                            activeOrdersTable.bindItems(activeOrders);
    	                }
    	                
                        if (pastOrders.length == 0)
                        {
                            Field.show($("pastOrdersTable"), false);
                        }
                        else
                        {
                            var pastOrdersTable = createOrdersTable($("pastOrdersTable"));
	                        pastOrdersTable.errorProvider = errorProvider;   // share errorProvider with the rest of the form
                            pastOrdersTable.bindItems(pastOrders);
    	                }
		            }

	            }
	            catch(e)
	            {
	                var message = "Failed to load preview page.  An exception occurred in the script. Error name: " + e.name + ". Error message: " + e.message;
		            Field.setValue($("myForm"), message);
	            }
		    }

		</script>
	</head>
	<body onload="javascript: onBodyLoad()">
		<form id="myForm">
		    <table width="640" border="0">
			    <tr>
				    <td width="422" class="pageheading"><div id="name"/></td>
				    <td width="202" rowspan="2"><div id="alerts"/></td>
			    </tr>
			    <tr>
				    <td class="pageheading2"><div id="mrn"/></td>
			    </tr>
		    </table>
    		
		    <p>&nbsp;</p>
		    <table width="640" border="0">
			    <tr>
				    <td width="120" class="propertyname">Date of Birth</td>
				    <td width="200"><div id="dateOfBirth"/></td>
				    <td width="63" class="propertyname">Sex</td>
				    <td width="229"><div id="sex"/></td>
			    </tr>
			    <tr>
				    <td class="propertyname">Healthcard # </td>
				    <td><div id="healthcard"/></td>
				    <td class="propertyname">&nbsp;</td>
				    <td>&nbsp;</td>
			    </tr>
		    </table>
    		
            <p>&nbsp;</p>
            <table width="640" border="0">
                <tr class="sectionheading">
                    <td colspan="4">Imaging Consultation Overview</td>
                </tr>
                <tr>
                    <td width="120" class="propertyname">Accession Number</td>
                    <td width="200"><div id="AccessionNumber"/></td>
                    <td width="120" class="propertyname">Priority</td>
                    <td width="200"><div id="OrderPriority"/></td>
                </tr>
                <tr>
                    <td width="120" class="propertyname">Ordering Physician</td>
                    <td width="200"><div id="OrderingPhysician"/></td>
                    <td width="120" class="propertyname">Facility</td>
                    <td width="200"><div id="OrderingFacility"/></td>
                </tr>
            </table>
            <table width="640" border="0" id="dsBreakdownTable">
                <tr>
                    <td colspan="6" class="tableheading">Diagnostic Service Breakdown</td>
                </tr>
            </table>

            <p>&nbsp;</p>
            <table width="640" border="0">
                <tr class="sectionheading">
                    <td colspan="4">Selected MPS Details</td>
                </tr>
                <tr>
                    <td width="120" class="propertyname">Name</td>
                    <td width="200"><div id="MPSName"/></td>
                    <td width="120" class="propertyname">Modality</td>
                    <td width="200"><div id="Modality"/></td>
                </tr>
                <tr>
                    <td width="120"  class="propertyname">Status</td>
                    <td width="200"><div id="ProcedureStepStatus"/></td>
                </tr>
                <tr id="DiscontinueReasonRow">
                    <td width="120" class="propertyname">Discontinue Reason</td>
                    <td colspan="3"><div id="DiscontinueReason"/></td>
                </tr>
                <tr>
                    <td width="120"  class="propertyname">Assigned Staff</td>
                    <td width="200"><div id="AssignedStaff"/></td>
                    <td width="120" class="propertyname">Performing Staff</td>
                    <td width="200"><div id="PerformingStaff"/></td>
                </tr>
                <tr>
                    <td width="120"  class="propertyname">Scheduled Start Time</td>
                    <td width="200"><div id="ScheduledStartTime"/></td>
                    <td width="120" class="propertyname">Scheduled End Time</td>
                    <td width="200"><div id="ScheduledEndTime"/></td>
                </tr>
                <tr>
                    <td width="120"  class="propertyname">Start Time</td>
                    <td width="200"><div id="StartTime"/></td>
                    <td width="120" class="propertyname">End Time</td>
                    <td width="200"><div id="EndTime"/></td>
                </tr>
            </table>
            <p>&nbsp;</p>
	        <table width="640" border="0" id="activeOrdersTable">
	            <tr class="sectionheading"><td colspan="6">Active Requests for Imaging Consultation</td></tr>
	            <tr class="tableheading">
		            <td>Requested Procedures</td>
		            <td>Scheduled For</td>
		            <td>Order Status</td>
		            <td>Insurance</td>
		            <td>Ordering Facility</td>
		            <td>Ordering Physician</td>
	            </tr>
	        </table>
	        <table width="640" border="0" id="pastOrdersTable">
	            <tr class="sectionheading"><td colspan="6">Past Requests for Imaging Consultation</td></tr>
	            <tr class="tableheading">
		            <td>Requested Procedures</td>
		            <td>Scheduled For</td>
		            <td>Order Status</td>
		            <td>Insurance</td>
		            <td>Ordering Facility</td>
		            <td>Ordering Physician</td>
	            </tr>
	        </table>
		</form>
	</body>
</html>