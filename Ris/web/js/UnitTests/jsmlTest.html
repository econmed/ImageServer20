<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<title>Jsml Unit Tests</title>
	<script type="text/javascript" src="../jsunit/app/jsUnitCore.js"></script>
	<script type="text/javascript" src="../jsx.js"></script>
	<script type="text/javascript" src="../jsml.js"></script>
	<script type="text/javascript">
		// A global variable that is included in the assert messages.  Helps to identify which test is currently running
		var currentTest = "";

/*

Found 3 problems with the unit tests that failed:

#1. Jsml.create does not check for null value
#2. Jsml.parse failed to parse \r
#3. Jsml.parse convert empty string (including only \r\n or spaces) into null, rather than empty string.  Inconsistent with .Net JsmlSerializer
#4. Jsml.create produces <Tag array=\"true\"></Tag>.  This is inconsistent with the <Tag array=\"true\"/> produced with .Net JsmlSerializer


*/

		function testNull()
		{
			currentTest = "Null value";
//#1			SerializeHelper(null, "");
			DeserializeHelper(null, "");
			DeserializeHelper(null, null);
}

		function testString()
		{
			currentTest = "Alphabets";
			SerializeHelper("abcdefghijklmnopqrstuvwxyz", "<Tag>abcdefghijklmnopqrstuvwxyz</Tag>");
			DeserializeHelper("abcdefghijklmnopqrstuvwxyz", "<Tag>abcdefghijklmnopqrstuvwxyz</Tag>");

			currentTest = "Numbers";
			SerializeHelper("000", "<Tag>000</Tag>");
			DeserializeHelper("000", "<Tag>000</Tag>");
			SerializeHelper("1234567890", "<Tag>1234567890</Tag>");
			DeserializeHelper("1234567890", "<Tag>1234567890</Tag>");

			currentTest = "Unusual characters";
			SerializeHelper("`~!@#$%^*()-_=+[{]}\|;:,./?", "<Tag>`~!@#$%^*()-_=+[{]}\|;:,./?</Tag>");
			DeserializeHelper("`~!@#$%^*()-_=+[{]}\|;:,./?", "<Tag>`~!@#$%^*()-_=+[{]}\|;:,./?</Tag>");

			currentTest = "Single & Double quotes";
			SerializeHelper("''", "<Tag>&apos;&apos;</Tag>");
			DeserializeHelper("''", "<Tag>&apos;&apos;</Tag>");
			SerializeHelper('""', '<Tag>&quot;&quot;</Tag>');
			DeserializeHelper('""', '<Tag>&quot;&quot;</Tag>');

			currentTest = "Escaped characters";
			SerializeHelper("&<>", "<Tag>&amp;&lt;&gt;</Tag>");
			DeserializeHelper("&<>", "<Tag>&amp;&lt;&gt;</Tag>");

			currentTest = "Line breaks";
			SerializeHelper("ABC\n", "<Tag>ABC\n</Tag>");
			DeserializeHelper("ABC\n", "<Tag>ABC\n</Tag>");

			SerializeHelper("ABC\r", "<Tag>ABC\r</Tag>");
//#2		DeserializeHelper("ABC\r", "<Tag>ABC\r</Tag>");

			SerializeHelper("ABC\r\nDEF", "<Tag>ABC\r\nDEF</Tag>");
//#2		DeserializeHelper("ABC\r\nDEF", "<Tag>ABC\r\nDEF</Tag>");

			SerializeHelper("\r\nDEF", "<Tag>\r\nDEF</Tag>");
//#2		DeserializeHelper("\r\nDEF", "<Tag>\r\nDEF</Tag>");

			SerializeHelper("ABC\r\n", "<Tag>ABC\r\n</Tag>");
//#2		DeserializeHelper("ABC\r\n", "<Tag>ABC\r\n</Tag>");

			SerializeHelper("\r\n", "<Tag>\r\n</Tag>");
			SerializeHelper("\r\n\r\n", "<Tag>\r\n\r\n</Tag>");
			SerializeHelper(" ", "<Tag> </Tag>");
			SerializeHelper("  ", "<Tag>  </Tag>");

			SerializeHelper(" \r\n", "<Tag> \r\n</Tag>");
			SerializeHelper("  \r\n", "<Tag>  \r\n</Tag>");
		}


		function testString_SpecialCase()
		{
			// Due to nature of Xml, a tag that contains only empty spaces and newline characters will deserialize to an empty string.
			// We will allow empty string for now.  If it causes problem in the future, we can wrap the info within the tag in cdata.
			var value = JSML.parse("<Tag>\r\n</Tag>");
//#3		assertTrue(value == "" || value == "\r\n");

			value = JSML.parse("<Tag> </Tag>");
//#3		assertTrue(value == "" || value == " ");

			value = JSML.parse("<Tag> \r\n</Tag>");
//#3		assertTrue(value == "" || value == " \r\n");
		}

		function testInt()
		{
			currentTest = "Integers zeroes";
			SerializeHelper(0, "<Tag>0</Tag>");
			DeserializeHelper(0, "<Tag>0</Tag>");

			SerializeHelper(00, "<Tag>0</Tag>");
			DeserializeHelper(00, "<Tag>0</Tag>");

			currentTest = "Integers non-zeroes";
			SerializeHelper(5, "<Tag>5</Tag>");
			DeserializeHelper(5, "<Tag>5</Tag>");

			SerializeHelper(99999, "<Tag>99999</Tag>");
			DeserializeHelper(99999, "<Tag>99999</Tag>");

			currentTest = "Negative integers";
			SerializeHelper(-1, "<Tag>-1</Tag>");
			DeserializeHelper(-1, "<Tag>-1</Tag>");

			SerializeHelper(-99999, "<Tag>-99999</Tag>");
			DeserializeHelper(-99999, "<Tag>-99999</Tag>");
		}

		function testDouble()
		{
			currentTest = "Double";
			SerializeHelper(0.00, "<Tag>0</Tag>");
			DeserializeHelper(0.00, "<Tag>0</Tag>");

			SerializeHelper(5.1, "<Tag>5.1</Tag>");
			DeserializeHelper(5.1, "<Tag>5.1</Tag>");

			SerializeHelper(-5.1, "<Tag>-5.1</Tag>");
			DeserializeHelper(-5.1, "<Tag>-5.1</Tag>");

			SerializeHelper(0.99999999, "<Tag>0.99999999</Tag>");
			DeserializeHelper(0.99999999, "<Tag>0.99999999</Tag>");

			SerializeHelper(0.001, "<Tag>0.001</Tag>");
			DeserializeHelper(0.001, "<Tag>0.001</Tag>");

			// Scientific notation.  Note that the serialized jsml is always non-capitalized and trimmed.  ie. e-8 rather than e-08
			// Make sure the upper case and padded E-08 E-8 can all be deserialized
			currentTest = "Scientific Notations";
			SerializeHelper(0.000000015, "<Tag>1.5e-8</Tag>");
			SerializeHelper(1.5E-08, "<Tag>1.5e-8</Tag>");
			SerializeHelper(15E-09, "<Tag>1.5e-8</Tag>");
			DeserializeHelper(0.000000015, "<Tag>1.5E-08</Tag>");
			DeserializeHelper(1.5E-8, "<Tag>1.5E-8</Tag>");
			DeserializeHelper(1.5E-8, "<Tag>1.5e-08</Tag>");
			DeserializeHelper(1.5E-8, "<Tag>1.5e-8</Tag>");
		}

		function testBool()
		{
			currentTest = "Bool: true";
			SerializeHelper(true, "<Tag>true</Tag>");
			DeserializeHelper(true, "<Tag>true</Tag>");

			currentTest = "Bool: false";
			SerializeHelper(false, "<Tag>false</Tag>");
			DeserializeHelper(false, "<Tag>false</Tag>");
		}

		function testNullableDateTime()
		{
			var now = new Date();

			// Serializer do not support milliseconds and below.
			var nowWithoutMilliseconds = new Date(now.getFullYear(), now.getMonth(), now.getDay(), now.getHours(), now.getMinutes(), now.getSeconds());

			currentTest = "DateTime";
			SerializeHelper(nowWithoutMilliseconds, "<Tag>" + nowWithoutMilliseconds.toISOString() + "</Tag>");
			DeserializeDate(nowWithoutMilliseconds, "<Tag>" + nowWithoutMilliseconds.toISOString() + "</Tag>");
			
			currentTest = "Null-DateTime";
			nowWithoutMilliseconds = null;
//#1		SerializeHelper(nowWithoutMilliseconds, "");
			DeserializeDate(nowWithoutMilliseconds, null);
			DeserializeDate(nowWithoutMilliseconds, "");
}

		function testList()
		{
			currentTest = "Empty List";
			var emptylist = [];
//#4		SerializeHelper(emptylist, "<Tag array=\"true\" />");
			SerializeHelper(emptylist, "<Tag array=\"true\"></Tag>");
			DeserializeHelper(emptylist, "<Tag array=\"true\" />");
			DeserializeHelper(emptylist, "<Tag array=\"true\"></Tag>");

			currentTest = "String List";
			stringList = [ "1" ];
			SerializeHelper(stringList, "<Tag array=\"true\"><item>1</item></Tag>");
			DeserializeHelper(stringList, "<Tag array=\"true\"><item>1</item></Tag>");
			DeserializeHelper(stringList, "<Tag array=\"true\">\r\n  <item>1</item>\r\n</Tag>");

			currentTest = "Integer List";
			intList = [ 1 ];
			SerializeHelper(intList, "<Tag array=\"true\"><item>1</item></Tag>");
			DeserializeHelper(intList, "<Tag array=\"true\"><item>1</item></Tag>");
			DeserializeHelper(intList, "<Tag array=\"true\">\r\n  <item>1</item>\r\n</Tag>");

			currentTest = "Double List";
			doubleList = [ 1.0 ];
			SerializeHelper(doubleList, "<Tag array=\"true\"><item>1</item></Tag>");
			DeserializeHelper(doubleList, "<Tag array=\"true\"><item>1</item></Tag>");
			DeserializeHelper(doubleList, "<Tag array=\"true\">\r\n  <item>1</item>\r\n</Tag>");

			currentTest = "Boolean List";
			boolList = [ true, false ];
			SerializeHelper(boolList, "<Tag array=\"true\"><item>true</item><item>false</item></Tag>");
			DeserializeHelper(boolList, "<Tag array=\"true\"><item>true</item><item>false</item></Tag>");
			DeserializeHelper(boolList, "<Tag array=\"true\">\r\n  <item>true</item>\r\n  <item>false</item>\r\n</Tag>");
		}

		function testDictionary()
		{
			currentTest = "Empty Dictionary";
			var emptyDictionary = {};
			SerializeHelper(emptyDictionary, "<Tag hash=\"true\"></Tag>");
			DeserializeDictionary(emptyDictionary, "<Tag hash=\"true\" />");
			DeserializeDictionary(emptyDictionary, "<Tag hash=\"true\"></Tag>");

			currentTest = "Str-Str Dictionary";
			var strStrDictionary = { "key": "value" };
			SerializeHelper(strStrDictionary, "<Tag hash=\"true\"><key>value</key></Tag>");
			DeserializeDictionary(strStrDictionary, "<Tag hash=\"true\">\r\n  <key>value</key>\r\n</Tag>");
			DeserializeDictionary(strStrDictionary, "<Tag hash=\"true\"><key>value</key></Tag>");

			currentTest = "Str-Int Dictionary";
			var strIntDictionary = { "key": 5 };
			SerializeHelper(strIntDictionary, "<Tag hash=\"true\"><key>5</key></Tag>");
			DeserializeDictionary(strIntDictionary, "<Tag hash=\"true\">\r\n  <key>5</key>\r\n</Tag>");
			DeserializeDictionary(strIntDictionary, "<Tag hash=\"true\"><key>5</key></Tag>");
		}

		function testDictionary_NonStringKeyType()
		{
			// This is not supported by the .Net JsmlSerializer.  But is supported in javascript counterpart.
			currentTest = "Int-Str Dictionary";
			var intStrDictionary = { 0: "value" };
			SerializeHelper(intStrDictionary, "<Tag hash=\"true\"><0>value</0></Tag>");

			try
			{
				DeserializeDictionary(intStrDictionary, "<Tag hash=\"true\"><0>value</0></Tag>");
			}
			catch (e)
			{
				var expectedMessage = "A name was started with an invalid character.\r\n" + "<Tag hash=\"true\"><0>value</0></Tag>";
				assertTrue(e == expectedMessage);
			}
		}

		function testDataContract()
		{
			currentTest = "Empty Contract";
			var emptyContract = {};
			SerializeHelper(emptyContract, "<Tag hash=\"true\"></Tag>");
			// not sure how to test parsing of  empty contract

			currentTest = "Populated Contract";
			var now = new Date();
			var nowWithoutMilliseconds = new Date(now.getFullYear(), now.getMonth(), now.getDay(), now.getHours(), now.getMinutes(), now.getSeconds());
			var contract = {
					Double: 5.0,
					Bool: true,
					DateTime: nowWithoutMilliseconds,
					ExtendedProperties: { key1: "value1" , key2: "value2" },
					ExpectedJsml: function()
						{
							return "<Tag hash=\"true\">"
								+ "<Double>" + this.Double + "</Double>"
								+ "<Bool>" + this.Bool + "</Bool>"
								+ "<DateTime>" + this.DateTime.toISOString() + "</DateTime>"
								+ "<ExtendedProperties hash=\"true\">"
									+ "<key1>" + this.ExtendedProperties.key1 + "</key1>"
									+ "<key2>" + this.ExtendedProperties.key2 + "</key2>"
								+ "</ExtendedProperties>"
								+ "</Tag>";
						},
					Equals: function(that)
						{
							return this.Double == contract.Double
								&& this.Bool == contract.Bool
								&& this.DateTime.toISOString() == contract.DateTime.toISOString()
								&& this.ExtendedProperties.key1 == contract.ExtendedProperties.key1
								&& this.ExtendedProperties.key2 == contract.ExtendedProperties.key2
						}
				};

				
			SerializeHelper(contract, contract.ExpectedJsml());
			var parsedValue = JSML.parse(contract.ExpectedJsml());
			assertTrue(currentTest, contract.Equals(parsedValue));
		}

		/************ Helper functions ************/

		function SerializeHelper(inputValue, expectedJsml)
		{
			var jsml = JSML.create(inputValue, "Tag");
			assertEquals(currentTest, expectedJsml, jsml);
		}

		function DeserializeHelper(expectedValue, jsml)
		{
			var value = JSML.parse(jsml);

			if (null == value)
			{
				assertNull(currentTest, expectedValue);
			}
			else if (expectedValue.isArray)
			{
				assertTrue(currentTest, CompareArrays(expectedValue, value));
			}
			else
			{
				assertTrue(currentTest, expectedValue == value);
			}
		}

		// Customize deserialize helper for date values.  When parsed, an date object is in its default format
		// which causes assert to fail when we compare a non ISO format with a ISO formatted date.
		function DeserializeDate(expectedValue, jsml)
		{
			var value = JSML.parse(jsml);

			if (null == value)
			{
				assertNull(currentTest, expectedValue);
			}
			else
			{
				assertTrue(currentTest, expectedValue.toISOString() == value.toISOString());
			}
		}

		// Customize deserialize helper for date values.  When parsed, an date object is in its default format
		// which causes assert to fail when we compare a non ISO format with a ISO formatted date.
		function DeserializeDictionary(expectedValue, jsml)
		{
			var value = JSML.parse(jsml);

			if (null == value)
			{
				assertNull(currentTest, expectedValue);
			}
			else
			{
				assertTrue(currentTest, CompareHashedObjects(expectedValue, value));
			}
		}

		// Compare two dictionary.  Return true if the arrays are equivalent.  Key and values of the dictionary must be primitives and not nested objects
		function CompareHashedObjects(x, y)
		{
			function ownPropertyLength(obj)
			{
				var count = 0;
				for (var p in obj)
				{
					if (obj.hasOwnProperty(p))
						count++;
				}

				return count;
			}

			if (x == null && y == null)
				return true;

			if (x == null || y == null)
				return false;

			if (ownPropertyLength(x) != ownPropertyLength(y))
				return false;

			for (var p in x)
			{
				if (x.hasOwnProperty(p))
				{
					if (x[p] != y[p])
						return false;
				}
			}

			return true;
		}

		// Compare two arrays.  Return true if the arrays are equivalent.  Ordering of the elements is important.
		function CompareArrays(x, y)
		{
			if (x == null && y == null)
				return true;

			if (x == null || y == null)
				return false;

			if (x.length != y.length)
				return false;

			// order matters, compare each item one by one
			for(var i = 0; i < x.length; i++)
			{
				if (x[i] != y[i])
				{
					alert(i + " " + x[i] + ", " + y[i]);
					return false;
				}
			}

			return true;
		}

		// A helper function that returns the value of the immediately children.
		function ShowMembers(obj, onlyShowOwnProperty)
		{
			var description = "";
			for (var p in obj)
			{
				if (onlyShowOwnProperty && !obj.hasOwnProperty(p))
					continue;

				var value = obj[p];
				description += p + ": " + value + "\r\n";
			}
			
			return description;
		}

	</script>
</head>

<body>
<h1>JSML Unit Tests</h1>

<p>This page contains test for the JSML javascript object.  Use the testRunner.html to run the tests.</p>
</body>
</html>
