<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <title>Radiologist Preview</title>
        <link href="css/default.css" rel="stylesheet" type="text/css" />
        <link href="css/tabs.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="js/jsx.js"></script>
	    <script type="text/javascript" src="js/jsml.js"></script>
	    <script type="text/javascript" src="js/ui.js"></script>
	    <script type="text/javascript" src="js/ris.js"></script>
	    <script type="text/javascript" src="js/preview.js"></script>
	    <script type="text/javascript" src="js/layout.js"></script>
	    <script type="text/javascript" src="js/tabs.js"></script>
		<script type="text/javascript" src="js/structuredreport.js"></script>
	    <script type="text/javascript" >
			var errorProvider = new ErrorProvider();
		 
		    function onBodyLoad()
		    {		        
                scaleWidth();
               
		        if(!Ris)
		            return;
		            
	            try
	            {
                    var worklistItem = Ris.getHealthcareContext();
                    if (worklistItem == null)
                    {
                        Field.setValue($("myForm"), "");
                        return;
                    }
					
                    // construct request object
                    var request = {
                        GetPatientProfileDetailRequest:
                             {
                                PatientProfileRef: worklistItem.PatientProfileRef,
                                IncludeAlerts: true
                             },
                        GetOrderDetailRequest:
                             { 
                                OrderRef: worklistItem.OrderRef,
                                IncludeAlerts: true,
                                IncludeNotes: true,
                                
                                // only include ordered procedures if report not yet created
                                IncludeProcedures: (worklistItem.ReportRef == null)
                             },
                        // only request the report detail if there is a report     
                        GetReportDetailRequest: worklistItem.ReportRef == null ? null : { ReportRef: worklistItem.ReportRef }
                    };
                   
                    
					var service = Ris.getPatientDataService();
                    var data = service.getData(request);
                    
                    if (data == null || data.length == 0)
                    {
                        Field.setValue($("myForm"), "");
                        return;
                    }
		            // update patient demography
	                var patientProfile = data.GetPatientProfileDetailResponse.PatientProfile;
	                var patientName = Ris.formatPersonName(patientProfile.Name);
		            if (patientProfile)
		            {
		                Field.setValue($("name"), patientName);
			            Field.setValue($("mrn"), Ris.formatMrn(patientProfile.Mrn));
			            Field.setValue($("age"), getPatientAge(patientProfile.DateOfBirth, patientProfile.DeathIndicator, patientProfile.TimeOfDeath));
			            Field.setValue($("sex"), patientProfile.Sex.Value);					
			            Field.setValue($("dateOfBirth"), Ris.formatDate(patientProfile.DateOfBirth));
			            Field.setValue($("healthcard"), Ris.formatHealthcard(patientProfile.Healthcard));
		            }

                    // update alerts
		            var alertNotifications = data.GetPatientProfileDetailResponse.PatientAlerts;
		            alertNotifications = alertNotifications.concat(data.GetOrderDetailResponse.OrderAlerts);
		            if (alertNotifications)
		            {
                        var alertHtml = "";
	                    alertNotifications.each(function(item) { alertHtml += getAlertHtml(item, patientName); });
                        $("alerts").innerHTML = alertHtml;
		            }
		            
	                var orderDetail = data.GetOrderDetailResponse.Order;
	                var reportDetail = data.GetReportDetailResponse ? data.GetReportDetailResponse.Report : null;
	                
	                // update Imaging Consultation Overview
                    Field.setValue($("AccessionNumber"), orderDetail.AccessionNumber);
                    Field.setValue($("OrderPriority"), orderDetail.OrderPriority.Value);
                    Field.setValue($("OrderingPhysician"), Ris.formatPersonName(orderDetail.OrderingPractitioner.Name));
                    Field.setValue($("OrderingFacility"), orderDetail.OrderingFacility.Name);
                    Field.setValue($("DiagnosticService"), orderDetail.DiagnosticService.Name);
                    
                    var procedures = reportDetail ? reportDetail.Procedures : orderDetail.Procedures;
                    
                    var selectedProcedure = procedures.find(
                                            function(rp) { return rp.ProcedureRef == worklistItem.ProcedureRef; });
					if (selectedProcedure)
					{
	                    Field.setValue($("procedure"), selectedProcedure.Type.Name);
	                    Field.setValue($("ProcedureStartTime"), "TODO");
	                    Field.setValue($("ProcedureEndTime"), "TODO");
					}
                    
                    if(orderDetail.Notes.length)
                        createOrderNotesTable($("orderNotesTable"), orderDetail.Notes);
                    else
                        Field.show($("orderNotesTable"), false);

					var reportDetail = data.GetReportDetailResponse ? data.GetReportDetailResponse.Report : null;
					if (reportDetail)
					{
						var procedures = reportDetail.Procedures;
						createProceduresTable($("proceduresTable"), procedures);
						createReportPreview($("report"), reportDetail);
					}
					else
					{
	                    // hide report section
						Field.show($("proceduresTable"), false);
					}
	            }
	            catch(e)
	            {
	                var message = "Failed to load preview page.  An exception occurred in the script. Error name: " + e.name + ". Error message: " + e.message;
		            Field.setValue($("myForm"), message);
	            }
		    }
		</script>
	</head>
	<body onload="javascript: onBodyLoad()" onresize="javascript: scaleWidth()">
		<form id="myForm">
		    <table width="100%" border="0">
			    <tr>
				    <td class="pageheading"><div id="name"/></td>
				    <td rowspan="2" align="right"><div id="alerts"/></td>
			    </tr>
			    <tr>
				    <td class="pageheading2"><div id="mrn"/></td>
			    </tr>
		    </table>
    		
		    <p>&nbsp;</p>
			<table width="100%" border="0">
				<tr>
					<td width="120" class="propertyname">Date of Birth</td>
					<td width="200"><div id="dateOfBirth"/></td>
					<td width="63" class="propertyname">Age</td>
					<td width="229"><div id="age"/></td>
					<td></td>
				</tr>
				<tr>
					<td class="propertyname">Healthcard # </td>
					<td><div id="healthcard"/></td>
					<td width="63" class="propertyname">Sex</td>
					<td width="229"><div id="sex"/></td>
					<td class="additionalentriescount">
						<script language="javascript" type="text/javascript">
							document.write(Ris.getActionHtml("Details", "more..."));
						</script>
					</td>
				</tr>
			</table>
		    
            <table width="100%" border="0">
                <tr>
                    <td class="sectionheading" colspan="4">Imaging Consultation Overview</td>
                </tr>
                <tr>
                    <td width="120" class="propertyname">Accession Number</td>
                    <td width="200"><div id="AccessionNumber"/></td>
                    <td width="120" class="propertyname">Priority</td>
                    <td width="200"><div id="OrderPriority"/></td>
                </tr>
                <tr>
                    <td width="120" class="propertyname">Ordering Physician</td>
                    <td width="200"><div id="OrderingPhysician"/></td>
                    <td width="120" class="propertyname">Ordering Facility</td>
                    <td width="200"><div id="OrderingFacility"/></td>
                </tr>
                <tr>
                    <td width="120" class="propertyname">Diagnostic Service</td>
                    <td width="200"><div id="DiagnosticService"/></td>
                    <td width="120" class="propertyname">Procedure</td>
                    <td width="200"><div id="procedure"/></td>
                </tr>
                <tr>
                    <td width="120" class="propertyname">Procedure Start Time</td>
                    <td width="200"><div id="ProcedureStartTime"/></td>
                    <td width="120" class="propertyname">Procedure End Time</td>
                    <td width="200"><div id="ProcedureEndTime"/></td>
                </tr>
            </table>
	        <table border="0" id="orderNotesTable">
	            <tr><td class="sectionheading" colspan="6">Order Notes</td></tr>
	            <tr class="tableheading">
		            <td>Comment</td>
		            <td>Time</td>
		            <td>Author</td>
	            </tr>
	        </table>

            <div id="reportSection">
    		    <p id="reportheading" class="sectionheading">Report</p>
		        <table border="0" id="proceduresTable">
		            <tr class="tableheading">
			            <td>Procedure</td>
			            <td>Protocol</td>
			            <td>Code</td>
		            </tr>
					<!-- this empty row is here so the color of the first data row is consistent with other previews -->
		            <tr colspan="3"></tr>
		        </table>
		        <div id="report"></div>
            </div>
		</form>
	</body>
</html>
