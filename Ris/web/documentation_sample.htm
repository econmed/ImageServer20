<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <!--<link href="default.css" rel="stylesheet" type="text/css" />-->
	    <script src="jsx.js"></script>
	    <script src="jsml.js"></script>
	    <script src="ui.js"></script>
	    <script src="ris.js"></script>
		<script>
		    var data;
		    var validation = new Validation();
	    
		    function initPage()
		    {
		        // if the Ris object is not defined, we are running in a plain old browser, so call setData manually
				if(!Ris)
				    setData(null);
		    }
		    
		    function setData(jsml)
		    {
			    data = JSML.parse(jsml) || {};
			    var myForm = $("myForm");
			    myForm.lastName.value = data.lastName || "";
			    myForm.firstName.value = data.firstName || "";
			    
			    data.relatives = data.relatives || [];
			    
			    // create relatives table
		        var relTable = DynamicTable.createTable($("relativesTable"), [{property: "name"}, {property: "relationship"}, {property: "doctor"}]);
		        relTable.rowCycleClassNames = ["row0", "row1"];
		        relTable.formatCell = function(sender, args)
		        {
		            if(args.column.property == "doctor" && !args.item.doctor)
		            {
		                args.htmlCell.innerHTML = "N/A";
		            }
		        }
		        relTable.bindItems(data.relatives);
		    }
		    
		    function getData()
		    {
			    var myForm = $("myForm");
		        data.lastName = myForm.lastName.value;
		        data.firstName =  myForm.firstName.value;
				return JSML.create(data, "data");
		    }

			function onFindStaff()
			{
			    var myForm = $("myForm");
			    var query = myForm.relativeDoctor.value || "";
			    var result = Ris.resolveStaffName(query);
			    if(result)
			        myForm.relativeDoctor.value = result;
			}
			
			function onAddRelative()
			{
			    var myForm = $("myForm");
			    data.relatives.add( {
			        name: myForm.relativeName.value,
			        relationship: myForm.relationship.value,
			        doctor: myForm.relativeDoctor.value });
			}
			
			function onDeleteRelative()
			{
			    var checkedItems = $("relativesTable").getCheckedItems();
			    if(checkedItems.length > 0)
			    {
			        if(confirm("Deleted selected relatives?"))
			        {
			            checkedItems.each(function(item) { data.relatives.remove(item); });
			        }
			    }
			    else
			    {
			        alert("Nothing selected");
			    }
			}
			function onRelativesCheckAllNone()
			{
			    data.relatives.each(function(item) { $("relativesTable").setItemCheckState(item, $("relativesCheckAllNone").checked); });
			}
			function updateValidation()
			{
			    var myForm = $("myForm");
			    validation.show(myForm.lastName, myForm.lastName.value ? "" : "Last name is required");
			    validation.show(myForm.firstName, myForm.firstName.value ? "" : "First name is required");
			}
		</script>
	</head>
	<body onload="javascript: initPage()">
	
		<form id="myForm">
		<p>Personal Data</p>
		<p>
		    Last Name<input type="text" id="lastName" onchange="updateValidation()"/>
		    First Name<input type="text" id="firstName" onchange="updateValidation()"/>
		</p>
		<p></p>
		<p>Relatives</p>
		<p>
		    Name<input type="text" id="relativeName"/>
		    Relationship
		    <select id="relationship">
		            <option value="Mother">Mother</option>
					<option value="Father">Father</option>
					<option value="Child">Child</option>
					<option value="Sibling">Sibling</option>
	        </select>
	        Doctor<input type="text" id="relativeDoctor"/><input type="button" value="Find" onclick="javascript: onFindStaff()" />
		</p>
		<p>
		    <input type="button" value="Add" onclick="javascript: onAddRelative()" />
		    <input type="button" value="Delete" onclick="javascript: onDeleteRelative()" />
		    <input type="button" value="Update Validation" onclick="javascript: updateValidation()" />
		</p>
			<table id="relativesTable">
			  <tr>
			    <td><input id="relativesCheckAllNone" type="checkbox" onclick="javascript: onRelativesCheckAllNone()" />All/None</td>
				<td class="tableheading">Name</td>
				<td class="tableheading">Relationship</td>
				<td class="tableheading">Doctor</td>
			  </tr>
			</table>
		</form>
	</body>
</html>